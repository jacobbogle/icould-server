<!DOCTYPE html>
<html>
<head>
    <title>iCloud Audio Server</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #f0f0f0; padding: 10px; border-bottom: 1px solid #ccc; }
        .tabs { display: flex; border-bottom: 1px solid #ccc; }
        .tab { padding: 10px 20px; cursor: pointer; background: #f1f1f1; border: 1px solid #ccc; border-bottom: none; }
        .tab.active { background: white; border-bottom: 1px solid white; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ccc; border-top: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <div style="float: left; margin-right: 20px;">
            <a href="/logout" style="color: #0066cc; text-decoration: none; font-weight: bold;">Logout</a>
        </div>
        <h1>iCloud Audio Server - {{ directory or "root" }}</h1>
        <p>Logged in as: {{ username }}</p>
        {% if username == 'admin' %}
        <div style="float: right;">
            {% if icloud_authenticated %}
            <span style="color: green;">☁️ iCloud Connected</span>
            {% elif is_registered %}
            <span style="color: blue;">☁️ iCloud Registered Successfully</span>
            {% else %}
            <a href="/icloud_login" style="color: red;">☁️ iCloud Login Required</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
    <div style="clear: both;"></div>
    
    <div class="tabs">
        <div class="tab active" onclick="showTab('audiobooks')">Audiobooks</div>
        <div class="tab" onclick="showTab('music')">Music</div>
        <div class="tab" onclick="showTab('ebooks')">Ebooks</div>
        <div class="tab" onclick="showTab('documents')">Documents</div>
        {% if user_type not in ['kid', 'teen'] %}
        {% if user_type != 'admin' %}
        <div class="tab" onclick="showTab('family')">Family</div>
        {% endif %}
        <div class="tab" onclick="showTab('sync')">Sync</div>
        <div class="tab" onclick="showTab('settings')">Settings</div>
        {% if username == 'admin' %}
        <div class="tab" onclick="showTab('users')">Users</div>
        {% endif %}
        {% endif %}
    </div>
    
    <div id="audiobooks" class="tab-content active">
        {% include 'tabs/_audiobooks_tab.html' %}
    </div>
    
    <div id="music" class="tab-content">
        {% include 'tabs/_music_tab.html' %}
    </div>
    
    <div id="ebooks" class="tab-content">
        {% include 'tabs/_ebooks_tab.html' %}
    </div>
    
    <div id="documents" class="tab-content">
        {% include 'tabs/_documents_tab.html' %}
    </div>
    
    {% if user_type not in ['kid', 'teen'] %}
    {% if user_type != 'admin' %}
    <div id="family" class="tab-content">
        {% include 'tabs/_family_tab.html' %}
    </div>
    {% endif %}
    
    <div id="sync" class="tab-content">
        {% include 'tabs/_sync_tab.html' %}
    </div>
    
    <div id="settings" class="tab-content">
        {% include 'tabs/_settings_tab.html' %}
    </div>
    
    {% if username == 'admin' %}
    <div id="users" class="tab-content">
        {% include 'tabs/_users_tab.html' %}
    </div>
    {% endif %}
    {% endif %}
    
    <script>
        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            const tabElement = document.querySelector(`.tab[onclick="showTab('${tabId}')"]`);
            const contentElement = document.getElementById(tabId);
            
            if (tabElement && contentElement) {
                tabElement.classList.add('active');
                contentElement.classList.add('active');
                // Remember the active tab
                localStorage.setItem('activeTab', tabId);
            }
        }
        
        // Toggle password change dropdown for kids
        function togglePasswordChange(kidUsername) {
            const dropdown = document.getElementById(`password-change-${kidUsername}`);
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        // Restore active tab on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab) {
                // Check if the tab exists on this page
                const tabElement = document.querySelector(`.tab[onclick="showTab('${savedTab}')"]`);
                const contentElement = document.getElementById(savedTab);
                if (tabElement && contentElement) {
                    showTab(savedTab);
                } else {
                    // If saved tab doesn't exist, clear it and default to audiobooks
                    localStorage.removeItem('activeTab');
                }
            }
        });
    </script>
</body>
</html>